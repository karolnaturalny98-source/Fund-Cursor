---
description: Backend/API rules (Route Handlers, Prisma, caching)
globs:
  - "app/api/**/*.{ts,tsx}"
  - "lib/queries/**/*.{ts,tsx}"
  - "lib/services/**/*.{ts,tsx}"
  - "prisma/**/*"
alwaysApply: false
---

# Backend Rules

## API & Validation
- Route Handlers pod `/api/*` (REST).
- Walidacja **Zod** i egzekwowanie ról (Clerk).
- **Server Actions** z `"use server"` tam, gdzie ma to sens (mutacje blisko UI).

## Data & Prisma
- `schema.prisma`; migracje przez `prisma migrate dev`.
- Po każdej zmianie schematu: **`npx prisma generate`**.
- Modele PascalCase, pola snake_case; enums (np. `DisputeStatus`).
- Seed: `prisma/seed.js`.


## Caching & Revalidate
- **Tagged revalidation** — po mutacjach odśwież odpowiednie tagi.
- Używaj helpera `revalidateTag` z `@/lib/cache` zamiast bezpośrednio z `next/cache` (workaround dla typów Next.js 16).
- Cache selektywny (historia cen, rankingi).
- Przykład tagów: `"companies"`, `"cashback-${clerkId}"`, `"admin-disputes"`, `"user-disputes-${userId}"`.

## Security
- Sanitizacja wejść, limity payload, brak sekretów w logach.
- `.env` poza repo; rotacja testowych kluczy.

## Telemetry & Analytics
- Rejestruj kliknięcia CTA; UTM w linkach zakupowych.
TEST_LOCAL_MODE_123