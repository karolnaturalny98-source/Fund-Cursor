---
description: FundedRank Project Rules (single-source, living document)
globs:
  - "**/*.ts"
  - "**/*.tsx"
  - "app/**/*"
  - "components/**/*"
  - "lib/**/*"
  - "prisma/**/*"
alwaysApply: true
---

# FundedRank – Project Rules (Living Doc)

> Ten plik jest **jedynym źródłem prawdy** dla zasad projektu, skrótu PRD/ARCH i workflow.  
> **Nie** utrzymujemy osobnych README/PRD/ARCHITECTURE na tym etapie — aktualizujemy **ten plik**.  
> Każdą zmianę odnotuj w **Changelog** poniżej.

## 0) Snapshot (Stack & Constraints)
- App: **Next.js 16 (App Router)** + **React 19**, **TypeScript 5**, **ESLint 9**, **Node ≥ 18.17**.
- UI: **Tailwind CSS 4.1+** + **shadcn/ui** (dark tokens; HSL CSS vars).
- Build: **ESM** – `"type": "module"` w `package.json`; configi w `.mjs` / `export default`.
- CSS: **PostCSS** z jedynym pluginem `@tailwindcss/postcss` (bez `autoprefixer`).
- Auth: **Clerk** (role via `publicMetadata.role`).
- Data: **Prisma** → PostgreSQL (Neon). Po zmianach schematu **zawsze** `npx prisma generate`.
- Hosting: **Vercel**.
- ⚠️ **Nie dodajemy** bibliotek poza stackiem powyżej.

## 1) Architecture & Structure
- Routing: `app/` (grupy `(auth)`, `admin/(tabs)` itd.). Domyślnie **Server Components**.
- Współdzielone UI: `components/` (+ `components/ui` dla shadcn).
- Dostęp do danych: `lib/queries/*`; logika domenowa: `lib/services/*`.
- Prisma: schema/migrations/seed w `prisma/`.
- Statyczne: `public/`. Artefakty testów: `test-results/`.

## 2) Product Brief (PRD — skrót)
**Cel:** porównywarka prop-firm z rankingiem, filtrowaniem, detalami firm, kodami zniżkowymi i cashbackiem (punkty → nagrody).  
**Grupy:** doświadczeni traderzy, nowicjusze, influencerzy.  
**MVP:** ranking+filtry, detale firmy (kody/linki + telemetry), logowanie (Clerk), panel użytkownika (wallet/historia/ulubione), rejestrowanie klików, ręczne przyznawanie punktów, panel admina.  
**KPI:** kliknięcia CTA, przychody afiliacyjne, liczba/realizacja punktów, powracający użytkownicy.

## 3) Feature Rules & UX
- Ranking: filtry (model, min cashback, kraj, typ konta, min payout), sorty (`popular`, `newest`, `cashback`, `rating`, `name`).
- Firma: zakładki (Overview/Challenges/Reviews/Offers/Announcements/Payouts), JSON-LD w sync z danymi.
- CTA/UTM + telemetry: `purchase_click`, `faq_expand`, `open_tos`, `copy_code`, favorites.
- Compare: max 3 firmy; używaj `CompareProvider`; re-use `parseCompareParam`.
- Wallet: `/api/wallet/{transactions,available,redeem}` + overlay historii i redeem.
- Disputes: `DisputeCase` + API (`/api/disputes`, `/api/user/disputes`, `/api/admin/disputes[/{id}]`).

## 4) Coding Style
- **TS + ES Modules**, 2 spacje, unikać `any`.
- Komponenty **PascalCase**, zmienne/funkcje **camelCase**, pliki **kebab-case**.
- Tailwind 4: w `globals.css` **@import "tailwindcss"**; brak starych dyrektyw.
- A11y (aria, focus, `sr-only`). Przed PR: `npm run lint`.
- **Typografia:** używamy wyłącznie komponentów `Heading` (`variant: hero/page/section/subsection/subsectionStrong`) i `Text` (`variant: lead/body/caption/eyebrow/stat`) dla nagłówków/opisów/statystyk. Zabronione są nowe inline `text-[clamp(...)]`, `text-3xl`, itp. Jeśli potrzebny inny rozmiar, dodaj wariant do komponentu lub token w `app/globals.css`.

## 5) API & Data
- Route Handlers pod `/api/*` (REST). Walidacja **Zod**.
- Role: `user`, `admin` (`publicMetadata.role`). `/admin` i `/api/admin/*` wymagają admina.
- Prisma: **migrations** (nie edytować wygenerowanego SQL); po zmianie `schema.prisma` uruchomić `npx prisma generate`.


## 6) Caching & Performance
- Preferuj **tagged revalidation** zamiast `force-dynamic`.
- Cache selektywny (rankingi, historie).
- Uważaj na klient-hydration; duże komponenty **lazy/dynamic**.

### Przykład (RSC fetch + revalidate)
```ts
// lib/queries/companies.ts
export async function getCompanies() {
  const res = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/companies`, {
    next: { tags: ['companies'], revalidate: 60 },
  });
  return res.json();
}

// app/api/admin/companies/route.ts (po mutacji)
import { revalidateTag } from 'next/cache';
export async function POST(req: Request) {
  // ...zapis w DB...
  revalidateTag('companies');
  return Response.json({ ok: true });
}
## 7) SEO & Analytics
- Aktualizuj JSON-LD Product/Offer w `lib/seo.ts` przy każdej zmianie stron detalu.
- OG/Twitter metadata w sync.
- UTM dopinane do linków zakupowych; spójna telemetry na listach/detalach/similar.


## 9) Commits & PRs
- Commity: krótkie, imperatywne.
- PR: opis problemu/rozwiązania + output `npm run lint`/tests + ewentualne `prisma migrate`.


## 10) Security
- Sanitizacja wejść, kontrola ról na backendzie.
- Sekrety wyłącznie w `.env`. Zero sekretów w commitach/logach.

## 11) Documentation (Embedded Policy)
> Nie utrzymujemy osobnych README/PRD/ARCH teraz.  
> Wszystkie wytyczne aktualizujemy **tutaj** + krótkie JSDoc w `lib/*` i komentarze przy złożonych hookach/flow.
- Jak aktualizować: edytuj odpowiednią sekcję (0–10) i dopisz wpis w **Changelog**.
- `AGENTS.md` (jeśli powstanie) to skrót tego pliku — nie alternatywa.

## 12) Roadmap (aktywny wycinek)
- Revalidate/cache tagami.
- Global currency switch (SSR + cookie/localStorage).
- UX polish: sticky card ↔ plan, copy tweaks, „report data issue”.

---## Build Scripts (informacyjnie)
- `"dev": "next dev"`, `"build": "next build"`, `"start": "next start"`,  
  `"lint": "eslint . --ext .ts,.tsx"`.

## Changelog
- **2025-01-XX:** Dodano zasady typografii (Heading/Text + zakaz inline font-size); zamknięto audyt spójności.
- **2025-11-12:** Utworzono „living doc"; scalono PRD/ARCH/README do Project Rules; dodano sekcję z przykładami tagged revalidation.
- **2025-01-XX:** Zaktualizowano wersję Next.js z 15 na 16; dostosowano konfigurację ESLint (ignorowanie .next/**, bardziej tolerancyjne reguły dla cleanup).
@fundedrank-project
MDC
